"use strict";(self.webpackChunkstaticdocs_starter=self.webpackChunkstaticdocs_starter||[]).push([[2887],{24286:(e,t,n)=>{n.d(t,{Ay:()=>c,RM:()=>s});var i=n(74848),r=n(28453);const s=[];function o(e){return(0,i.jsx)(i.Fragment,{})}function c(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(o,{...e})}):o()}},28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>c});var i=n(96540);const r={},s=i.createContext(r);function o(e){const t=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(s.Provider,{value:t},e.children)}},91863:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>a,default:()=>u,frontMatter:()=>c,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"tutorial/test-environment","title":"Test Environment","description":"In the previous chapter a test was created that validates the output of a jq expression with input from the Github API. Using glob output expectations made the test stable, but at the cost of losing precision. This chapter explains how both stability and precision can be achieved.","source":"@site/docs/tutorial/05-test-environment.md","sourceDirName":"tutorial","slug":"/tutorial/test-environment","permalink":"/scrut/docs/tutorial/test-environment","draft":false,"unlisted":false,"editUrl":"https://www.internalfb.com/code/fbsource/fbcode/clifoundation/scrut/website/docs/tutorial/05-test-environment.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Output Expectations","permalink":"/scrut/docs/tutorial/output-expectations"},"next":{"title":"Test Configuration","permalink":"/scrut/docs/tutorial/test-configuration"}}');var r=n(74848),s=n(28453),o=n(24286);const c={},a="Test Environment",d={},l=[...o.RM,{value:"Test Fixtures",id:"test-fixtures",level:2},{value:"Environment Variables",id:"environment-variables",level:2},{value:"Working Directory",id:"working-directory",level:2}];function h(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components},{FbInternalOnly:n}=t;return n||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("FbInternalOnly",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"test-environment",children:"Test Environment"})}),"\n",(0,r.jsx)(n,{children:(0,r.jsx)(o.Ay,{})}),"\n",(0,r.jsxs)(t.p,{children:["In the previous chapter a test was created that validates the output of a ",(0,r.jsx)(t.code,{children:"jq"})," expression with input from the Github API. Using ",(0,r.jsx)(t.code,{children:"glob"})," output expectations made the test stable, but at the cost of losing precision. This chapter explains how both stability and precision can be achieved."]}),"\n",(0,r.jsx)(t.h2,{id:"test-fixtures",children:"Test Fixtures"}),"\n",(0,r.jsxs)(t.p,{children:["The reason why ",(0,r.jsx)(t.code,{children:"glob"})," was used was that the output of ",(0,r.jsx)(t.code,{children:"curl 'https://api.github.com/repos/jqlang/jq/commits?per_page=5'"})," was simply not stable: The output is changing over time."]}),"\n",(0,r.jsxs)(t.p,{children:["However, there is another alternative to stabilize the test: Storing the output of the ",(0,r.jsx)(t.code,{children:"curl"})," command in a file and using the file contents as input for ",(0,r.jsx)(t.code,{children:"jq"}),". A classic ",(0,r.jsx)(t.strong,{children:"test fixture"}),". This way the test input will not change, making the test stable, while retaining the higher precision."]}),"\n",(0,r.jsxs)(t.p,{children:["First create a new file ",(0,r.jsx)(t.code,{children:"expectations-fixture.txt"})," in ",(0,r.jsx)(t.strong,{children:"the same directory"})," as ",(0,r.jsx)(t.code,{children:"expectations.md"})," and add the following:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-plain",metastring:'title="tests/expectations-fixture.txt" showLineNumbers',children:"2025-03-28T00:57:51Z,dependabot[bot]\n2025-03-28T00:56:51Z,dependabot[bot]\n2025-03-28T00:55:39Z,dependabot[bot]\n2025-03-27T23:43:06Z,itchyny\n2025-03-27T23:42:44Z,itchyny\n"})}),"\n",(0,r.jsxs)(t.p,{children:["Now with that in place, the ",(0,r.jsx)(t.code,{children:"expectations.md"})," test document can be updated to use the fixture instead of the ",(0,r.jsx)(t.code,{children:"curl"})," command:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-markdown",metastring:'title="tests/expectations.md" showLineNumbers {4-5}',children:'# Output Expectations\n\n```scrut\n$ cat "$TESTDIR"/expectations-fixture.txt | \\\n>   jq -r \'.[] | .commit.committer.date + "," + .commit.author.name\'\n2025-03-28T00:57:51Z,dependabot[bot]\n2025-03-28T00:56:51Z,dependabot[bot]\n2025-03-28T00:55:39Z,dependabot[bot]\n2025-03-27T23:43:06Z,itchyny\n2025-03-27T23:42:44Z,itchyny\n```\n'})}),"\n",(0,r.jsx)(t.admonition,{type:"note",children:(0,r.jsxs)(t.p,{children:["Test fixtures are extremely helpful to increase test isolation. Using the fixture above categorically removed internet access, ",(0,r.jsx)(t.code,{children:"github.com"})," availability and ",(0,r.jsx)(t.code,{children:"curl"})," availability and functionality as dependencies from the test."]})}),"\n",(0,r.jsx)(t.h2,{id:"environment-variables",children:"Environment Variables"}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"TESTDIR"})," environment variable that is now used in ",(0,r.jsx)(t.code,{children:"expectations.md"})," is a special variable that is automatically set by Scrut. It contains the path of the directory where the test file that is currently being executed is located."]}),"\n",(0,r.jsx)(t.p,{children:"Two other very useful environment variables are:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"TMPDIR"}),": A temporary directory that is created for every Scrut execution automatically. It is removed when all tests are done."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"SCRUT_TEST"}),": Is set to contain the path and the line number where the where the test case is located in the test document (.e.g ",(0,r.jsx)(t.code,{children:"dir/test.md:123"}),")"]}),"\n"]}),"\n",(0,r.jsx)(t.admonition,{type:"info",children:(0,r.jsxs)(t.p,{children:["Learn about all ",(0,r.jsx)(t.a,{href:"/docs/reference/fundamentals/environment-variables/",children:"environment variables"})," that Scrut maintains."]})}),"\n",(0,r.jsx)(t.h2,{id:"working-directory",children:"Working Directory"}),"\n",(0,r.jsxs)(t.p,{children:["Scrut creates a temporary directory for each test document that is processed in ",(0,r.jsx)(t.code,{children:"scrut test"})," or ",(0,r.jsx)(t.code,{children:"scrut update"}),". This directory becomes the current working directory (CWD) for the test execution."]}),"\n",(0,r.jsxs)(t.p,{children:["This working directory directory does not contain test documents or test fixtures. This is the reason why the environment variable ",(0,r.jsx)(t.code,{children:"TESTDIR"})," was earlier used to ",(0,r.jsx)(t.code,{children:"cat"})," the fixture file:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-markdown",children:'```scrut\n$ cat "$TESTDIR"/expectations-fixture.txt | \\\n>   jq -r \'.[] | .commit.committer.date + "," + .commit.author.name\'\n-- %< --\n```\n'})}),"\n",(0,r.jsxs)(t.p,{children:["While the working directory is temporary, it is still shared between all test cases. So files can be written into it and picked up by later test cases. However, the above mentioned ",(0,r.jsx)(t.code,{children:"TMPDIR"})," environment variable is even better for that."]}),"\n",(0,r.jsxs)(t.p,{children:["To access the current directory either execute ",(0,r.jsx)(t.code,{children:"pwd"})," or access the ",(0,r.jsx)(t.code,{children:"PWD"})," environment variable:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-markdown",children:'```scrut\n$ echo "I am in $(pwd), which is not $TESTDIR"\n```\n'})}),"\n",(0,r.jsx)(t.admonition,{type:"info",children:(0,r.jsxs)(t.p,{children:["Learn more about the working directory in ",(0,r.jsx)(t.a,{href:"/docs/reference/behavior/working-directory/",children:"Reference > Behavior > Working Directory"}),"."]})})]})}function u(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}}}]);